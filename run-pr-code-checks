#!/bin/bash -ex
PULL_REQUEST=$1
export USER_CODE_CHECKS=$2
NUM_PROC=$(getconf _NPROCESSORS_ONLN)
case $(hostname) in lxplus* ) let NUM_PROC=$NUM_PROC/2 ;; esac
if [ $NUM_PROC = "0" ] ; then NUM_PROC=1; fi
cd $CMSSW_BASE
git cms-merge-topic -u ${PULL_REQUEST} 2>&1 | tee cms-merge-topic.log
scram build -j $NUM_PROC code-checks   2>&1 | tee code-checks.log
rm -rf upload
mv ${CMSSW_BASE}/tmp/${SCRAM_ARCH}/code-checks-logs upload
mv cms-merge-topic.log upload/
mv code-checks.log upload/
cd $CMSSW_BASE/src
git diff > ${CMSSW_BASE}/upload/git-diff.patch

