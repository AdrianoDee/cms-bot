#!/bin/sh -ex
WORKFLOWS=$1
PROFILES=$2
for prof in ${PROFILES} ; do
  mkdir -p $WORKSPACE/igprof/${prof}
  cd $WORKSPACE/igprof/${prof}
  runTheMatrix.py $WORKFLOWS --command "--profile $prof" > runTheMatrix.log
  for f in $(find . -name '*.gz' -type f) ; do
    echo "processing file $f"
    OUTFILE=${f//.gz/.sql3}
    echo $OUTFILE
    igprof-analyse -d -c $f --sqlite > $f.sql
    ERR=0
    sqlite3 $OUTFILE < $f.sql > $f.log || ERR=1
    if [ $ERR -gt 0 ] ; then
      cat $f.log
      exit 1
    fi
  done
done
