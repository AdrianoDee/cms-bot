#!/bin/sh
#CMSSW DAS_CLIENT SIGNATURE:12345678901234567890ABCDEFABCDEF#
#Do not change the contents of above line. It is signature for the cmssw ibs das_cleint wrapper
QUERY=
FORMAT="plain"
HELP=
for ((i=1; i<=$#; i++)); do
  next=$((i+1))
  case  ${!i} in
    --query=*  ) QUERY=$(echo ${!i} | sed 's|.*=||') ;;
    --query    ) QUERY=${!next} ;;
    --format=* ) FORMAT=$(echo ${!i} | sed 's|.*=||') ;;
    --format   ) FORMAT=${!next} ;;
    -h|--help  ) HELP=YES ;;
  esac
done

ORIG_DAS_CLIENT=""
WRAPPER_DAS_CLIENT_SIGN=$(head -2 $0 | tail -1)
for DAS_CLIENT in $(echo $PATH | tr ':' '\n' | sed 's|$|/das_client|') ; do
 [ -e ${DAS_CLIENT} ] || continue
 if [ "${WRAPPER_DAS_CLIENT_SIGN}" != "$(head -2 ${DAS_CLIENT} | tail -1)" ] ; then ORIG_DAS_CLIENT=${DAS_CLIENT}; break; fi
done

if [ "X${ORIG_DAS_CLIENT}" = "X" ] ; then
  echo "das_client: Command not found." 1>&2
  exit 1
fi

if [ "${QUERY}" = "" -o "${HELP}" != "" ] ; then
  ${ORIG_DAS_CLIENT} "$@"
  exit $?
fi

QUERY_SHA=$(echo -n "${QUERY}" | sha256sum | sed 's| .*$||;s| *||;s|^\(..\)|\1/\1|')
QUERY_URL="https://raw.githubusercontent.com/cms-sw/cms-sw.github.io/master/das_queries/${QUERY_SHA}"
if [ "${FORMAT}" = "json" ]  ; then
  QUERY_RESULTS=$(curl -L -s "${QUERY_URL}.json" || true)
else
  QUERY_RESULTS=$((curl -L -s "${QUERY_URL}" || true) | grep /store/ | sed 's| *||g;s|"||g;s|,||g')
fi

if [ "${QUERY_RESULTS}" != "" ] ; then
  if [ "${FORMAT}" = "json" ]  ; then 
    echo "${QUERY_RESULTS}"
  else
    echo "${QUERY_RESULTS}" | tr ' ' '\n'
  fi
else
  ${ORIG_DAS_CLIENT} "$@"
fi

