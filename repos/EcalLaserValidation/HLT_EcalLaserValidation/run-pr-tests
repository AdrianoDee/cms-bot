#!/bin/bash -ex
ERR=0
./steps.sh || ERR=1
CMSSW_DIR=$(ls -d CMSSW_*)
if [ "X${CMSSW_DIR}" = "X" ] ; then exit 0; fi
mv ${CMSSW_DIR}/src ${WORKSPACE}/upload/${CMSSW_DIR}
find ${WORKSPACE}/upload/${CMSSW_DIR} -name '*.root' -type f | xargs --no-run-if-empty rm -f
JOB_SUMMARY_LOG="${WORKSPACE}/summary.txt"
echo "## Differences found for various paths" > ${JOB_SUMMARY_LOG}
for diff_file in $(find ${WORKSPACE}/upload/${CMSSW_DIR} -name '*_diff.log' -type f | sed 's|_diff.log||') ; do
  path=$(basename $diff_file)
  echo "### $path" >> ${JOB_SUMMARY_LOG}
  echo '```' >> ${JOB_SUMMARY_LOG}
  cat ${diff_file}_diff.log >> ${JOB_SUMMARY_LOG}
  echo '```' >> ${JOB_SUMMARY_LOG}
done
exit $ERR
